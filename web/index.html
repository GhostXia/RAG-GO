<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG-GO - 本地RAG系统</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        h1 {
            margin: 0;
        }
        .subtitle {
            font-style: italic;
            color: #ecf0f1;
        }
        .container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .card {
            background-color: white;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 300px;
        }
        h2 {
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }
        form {
            margin-top: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background-color: #2980b9;
        }
        #results {
            margin-top: 20px;
        }
        .result-item {
            background-color: #f9f9f9;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 0 5px 5px 0;
        }
        .result-content {
            margin-top: 10px;
            white-space: pre-line;
        }
        .result-meta {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }
        .score {
            font-weight: bold;
            color: #e74c3c;
        }
        #document-list {
            list-style: none;
            padding: 0;
        }
        .document-item {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .document-item:hover {
            background-color: #f5f5f5;
        }
        .delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            width: auto;
        }
        .delete-btn:hover {
            background-color: #c0392b;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <header>
        <h1>RAG-GO</h1>
        <p class="subtitle">基于Go语言的本地RAG系统，支持SillyTavern集成</p>
    </header>

    <div class="container">
        <div class="card">
            <h2>文档上传</h2>
            <form id="upload-form">
                <label for="file">选择文件：</label>
                <input type="file" id="file" name="file" required>
                <button type="submit">上传文档</button>
            </form>
            <div id="upload-status"></div>

            <h2>文档列表</h2>
            <div id="documents-container">
                <div class="loading">加载中...</div>
                <ul id="document-list"></ul>
            </div>
        </div>

        <div class="card">
            <h2>向量搜索</h2>
            <form id="search-form">
                <label for="query">搜索查询：</label>
                <textarea id="query" name="query" rows="4" placeholder="输入您的查询内容..." required></textarea>
                <label for="limit">结果数量：</label>
                <input type="number" id="limit" name="limit" value="5" min="1" max="20">
                <button type="submit">搜索</button>
            </form>

            <div id="results">
                <!-- 搜索结果将在这里显示 -->
            </div>
        </div>
    </div>

    <script>
        // 文档上传
        document.getElementById('upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('file');
            const statusDiv = document.getElementById('upload-status');
            
            if (!fileInput.files[0]) {
                statusDiv.innerHTML = '<p style="color: red;">请选择文件</p>';
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            statusDiv.innerHTML = '<p>上传中...</p>';
            
            try {
                const response = await fetch('/api/documents', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = `<p style="color: green;">上传成功！共处理 ${result.chunks} 个文本块</p>`;
                    // 刷新文档列表
                    loadDocuments();
                } else {
                    statusDiv.innerHTML = `<p style="color: red;">上传失败：${result.error}</p>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<p style="color: red;">上传出错：${error.message}</p>`;
            }
        });
        
        // 搜索功能
        document.getElementById('search-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const query = document.getElementById('query').value;
            const limit = document.getElementById('limit').value;
            const resultsDiv = document.getElementById('results');
            
            resultsDiv.innerHTML = '<div class="loading">搜索中...</div>';
            
            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query, limit: parseInt(limit) })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    if (result.results.length === 0) {
                        resultsDiv.innerHTML = '<p>没有找到匹配的结果</p>';
                        return;
                    }
                    
                    let html = `<h3>查询: "${result.query}"</h3>`;
                    
                    result.results.forEach(item => {
                        html += `
                            <div class="result-item">
                                <div class="result-content">${item.document.content}</div>
                                <div class="result-meta">
                                    <span>来源: ${item.document.metadata.source}</span> | 
                                    <span>标题: ${item.document.metadata.title}</span> | 
                                    <span>相似度: <span class="score">${(item.score * 100).toFixed(2)}%</span></span>
                                </div>
                            </div>
                        `;
                    });
                    
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = `<p style="color: red;">搜索失败：${result.error}</p>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;">搜索出错：${error.message}</p>`;
            }
        });
        
        // 加载文档列表
        async function loadDocuments() {
            const documentsContainer = document.getElementById('documents-container');
            const documentList = document.getElementById('document-list') || document.createElement('ul');
            documentList.id = 'document-list';
            
            documentsContainer.innerHTML = '<div class="loading">加载中...</div>';
            
            try {
                const response = await fetch('/api/documents');
                const documents = await response.json();
                
                if (response.ok) {
                    if (!documents || documents.length === 0) {
                        documentsContainer.innerHTML = '<p>没有上传的文档</p>';
                        return;
                    }
                    
                    // 按标题和来源分组文档
                    const groupedDocs = {};
                    documents.forEach(doc => {
                        const key = `${doc.metadata.title}_${doc.metadata.source}`;
                        if (!groupedDocs[key]) {
                            groupedDocs[key] = {
                                title: doc.metadata.title,
                                source: doc.metadata.source,
                                count: 0,
                                ids: []
                            };
                        }
                        groupedDocs[key].count++;
                        groupedDocs[key].ids.push(doc.id);
                    });
                    
                    let html = '';
                    Object.values(groupedDocs).forEach(group => {
                        html += `
                            <li class="document-item">
                                <div>
                                    <strong>${group.title}</strong> (${group.source})
                                    <span>${group.count} 个文本块</span>
                                </div>
                                <button class="delete-btn" data-ids='${JSON.stringify(group.ids)}'>删除</button>
                            </li>
                        `;
                    });
                    
                    documentList.innerHTML = html;
                    documentsContainer.innerHTML = '';
                    documentsContainer.appendChild(documentList);
                    
                    // 添加删除事件监听器
                    document.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const ids = JSON.parse(this.getAttribute('data-ids'));
                            if (confirm(`确定要删除这个文档吗？`)) {
                                for (const id of ids) {
                                    await deleteDocument(id);
                                }
                                loadDocuments(); // 重新加载列表
                            }
                        });
                    });
                } else {
                    documentsContainer.innerHTML = `<p style="color: red;">加载失败</p>`;
                }
            } catch (error) {
                documentsContainer.innerHTML = `<p style="color: red;">加载出错：${error.message}</p>`;
            }
        }
        
        // 删除文档
        async function deleteDocument(id) {
            try {
                await fetch(`/api/documents/${id}`, {
                    method: 'DELETE'
                });
                return true;
            } catch (error) {
                console.error('删除文档失败:', error);
                return false;
            }
        }
        
        // 页面加载时获取文档列表
        window.addEventListener('load', loadDocuments);
    </script>
</body>
</html>